# MuDiKo KI Assistant - Docker Compose Configuration
# 
# Dieses Setup startet:
# - Backend: Flask API (Python) intern auf Port 5000 
# - Frontend: React App (nginx) intern auf Port 80
# - Caddy: Reverse Proxy mit automatischem HTTPS auf Port 443
# - Automatisches Health Monitoring
#
# Start: docker-compose up -d
# Stop:  docker-compose down
# Logs:  docker-compose logs

services:
  # Backend Service - Flask API + Audio Processing
  backend:
    build: ./Backend
    container_name: mudiko-backend
    expose:
      - "5000"                   # Nur intern im Docker-Netzwerk erreichbar
    volumes:
      - ./Backend/app/Uploads:/workspace/app/Uploads  # Persistente Audio-Speicherung
    environment:
      - FLASK_ENV=production     # Produktions-Modus
      - PYTHONUNBUFFERED=1       # Live-Logging
      - SECRET_KEY=${SECRET_KEY}                  # Pflicht in Produktion: sicherer geheimer Schlüssel
      - CORS_ORIGINS=${CORS_ORIGINS:-https://music.ifib.eu}  # Erlaubte Origin(s)
      - SESSION_TTL_SECONDS=${SESSION_TTL_SECONDS:-3600}     # 1h TTL
      - GC_INTERVAL_SECONDS=${GC_INTERVAL_SECONDS:-900}       # 15 Min Intervall
      - MAX_CONTENT_LENGTH=${MAX_CONTENT_LENGTH:-104857600}   # 100 MB Upload-Limit
    restart: unless-stopped      # Auto-Restart bei Fehlern
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s             # Alle 30 Sekunden prüfen
      timeout: 10s              # 10 Sekunden Timeout
      retries: 3                # 3 Versuche vor "unhealthy"
    networks:
      - mudiko-network

  # Frontend Service - React App mit nginx
  frontend:
    build: ./Frontend
    container_name: mudiko-frontend
    expose:
      - "80"                     # Nur intern im Docker-Netzwerk erreichbar
    depends_on:
      - backend                  # Startet erst nach Backend
    restart: unless-stopped      # Auto-Restart bei Fehlern
    networks:
      - mudiko-network

  # Caddy Reverse Proxy - HTTPS mit automatischen Zertifikaten
  caddy:
    image: caddy:2.7-alpine
    container_name: mudiko-caddy
    ports:
      - "80:80"                  # HTTP (automatischer Redirect zu HTTPS)
      - "443:443"                # HTTPS
      - "443:443/udp"            # HTTP/3 (QUIC)
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data         # SSL-Zertifikate
      - caddy-config:/config     # Caddy-Konfiguration
      - caddy-logs:/data         # Access Logs
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    networks:
      - mudiko-network

# Netzwerk für Container-Kommunikation
networks:
  mudiko-network:
    driver: bridge
    name: mudiko-network

# Persistente Volumes
volumes:
  uploads:
    driver: local
    name: mudiko-uploads
  caddy-data:
    driver: local
    name: mudiko-caddy-data
  caddy-config:
    driver: local
    name: mudiko-caddy-config
  caddy-logs:
    driver: local
    name: mudiko-caddy-logs